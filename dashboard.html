<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoutPass | Admin Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-light: #EEF2FF;
            --secondary: #64748B;
            --bg: #F8FAFC;
            --card-bg: #FFFFFF;
            --border: #E2E8F0;
            --sidebar-width: 280px;
        }

        body {
            background-color: var(--bg);
            color: #1E293B;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .sidebar {
            position: fixed;
            height: 100vh;
            width: var(--sidebar-width);
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            padding: 24px;
            z-index: 1000;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--secondary);
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .nav-item.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(148, 163, 184, 0.05);
            transition: transform 0.2s;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(148, 163, 184, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0F172A;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 16px;
        }

        .custom-table thead th {
            background: var(--bg);
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .table-hover tbody tr:hover {
            background-color: var(--primary-light);
            cursor: pointer;
        }

        .lock-btn {
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 600;
            border: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .unlocked {
            background: #ECFDF5;
            color: #059669;
            border: 1px solid #059669;
        }

        .locked {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #DC2626;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
            }
        }

        .admin-only {
            display: none;
        }

        #loading-screen {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Footer Style */
        .footer-credit {
            margin-top: auto;
            padding-top: 40px;
            text-align: center;
            color: var(--secondary);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 50px;
            padding-bottom: 10px;
        }

        .footer-credit strong {
            color: var(--primary);
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div id="loading-screen">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
    <div id="qr-hidden" style="display:none"></div>
    <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">

    <div class="sidebar">
        <div class="d-flex align-items-center gap-2 mb-5">
            <div
                style="width: 40px; height: 40px; background: var(--primary); border-radius: 10px; color: white; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-shield-fill"></i>
            </div>
            <div style="line-height: 1.2; font-weight:700; font-size:1.2rem;">ScoutPass<div
                    style="font-size: 0.8rem; color: var(--secondary); font-weight: 500;">Admin Pro</div>
            </div>
        </div>

        <div class="nav-item active" onclick="showSection('overview', this)"><i class="bi bi-grid-fill"></i> Dashboard
        </div>
        <div class="nav-item" onclick="showSection('livelogs', this)"><i class="bi bi-activity"></i> Live Logs</div>
        <div class="nav-item" onclick="showSection('directory', this)"><i class="bi bi-people-fill"></i> Scouts List
        </div>
        <div class="nav-item" onclick="showSection('registration', this)"><i class="bi bi-person-plus-fill"></i>
            Registration</div>
        <div class="nav-item" onclick="showSection('events', this)"><i class="bi bi-calendar-check-fill"></i> Events
        </div>
        <div class="nav-item text-danger" onclick="showSection('alerts', this)"><i class="bi bi-bell-fill"></i> Alerts
            <span id="alertBadge" class="badge bg-danger rounded-pill ms-auto" style="display:none">0</span>
        </div>
        <hr class="my-4" style="border-color: var(--border);">
        <div class="nav-item admin-only" onclick="showSection('staff', this)"><i class="bi bi-shield-lock-fill"></i>
            Staff Access</div>
        <div class="nav-item admin-only" onclick="showSection('settings', this)"><i class="bi bi-gear-fill"></i>
            Settings</div>
        <div class="nav-item text-danger mt-2" onclick="logout()"><i class="bi bi-box-arrow-left"></i> Sign Out</div>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-1" id="pageTitle">Dashboard</h2>
                <div class="text-muted small"><span id="dateDisplay"></span> â€¢ <span id="clock">--:--</span></div>
            </div>
            <button id="globalLockBtn" class="lock-btn unlocked admin-only" onclick="toggleScannerLock()"><i
                    class="bi bi-unlock-fill"></i> System Active</button>
        </div>

        <div id="sec-overview" class="section animate__animated animate__fadeIn">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#EEF2FF; color:#4F46E5"><i
                                class="bi bi-qr-code-scan"></i></div>
                        <div class="text-uppercase small fw-bold text-muted mb-2">All Time Scans</div>
                        <div class="stat-value" id="statTotalScans">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#F3E8FF; color:#7E22CE"><i
                                class="bi bi-calendar-day-fill"></i></div>
                        <div class="text-uppercase small fw-bold text-muted mb-2">Scans Today</div>
                        <div class="stat-value" id="statTodayScans">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#DCFCE7; color:#166534"><i
                                class="bi bi-person-check-fill"></i></div>
                        <div class="text-uppercase small fw-bold text-muted mb-2">Currently Inside</div>
                        <div class="stat-value text-success" id="statInside">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:#E0F2FE; color:#0284C7"><i
                                class="bi bi-people-fill"></i></div>
                        <div class="text-uppercase small fw-bold text-muted mb-2">Total Registered</div>
                        <div class="stat-value" id="statTotalScouts">0</div>
                    </div>
                </div>
            </div>
            <h5 class="fw-bold text-secondary mb-3">Live Activity Monitor</h5>
            <div id="liveEventCards" class="row g-4">
                <div class="col-12 text-center text-muted py-5">
                    <div class="spinner-border text-primary mb-2"></div>
                    <div>Connecting...</div>
                </div>
            </div>
        </div>

        <div id="sec-alerts" class="section" style="display:none;">
            <div class="stat-card border-danger border-start border-5">
                <div class="d-flex justify-content-between mb-4">
                    <h5 class="fw-bold text-danger">Missing Scout Alerts</h5><button onclick="clearAlerts()"
                        class="btn btn-sm btn-outline-secondary admin-only">Clear All</button>
                </div>
                <table class="table align-middle">
                    <tbody id="alertsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-livelogs" class="section" style="display:none;">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0">Real-time Feed</h5><span
                        class="badge bg-light text-primary border">Live</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle custom-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Scout</th>
                                <th>Event</th>
                                <th>Status</th>
                                <th>Scanner</th>
                            </tr>
                        </thead>
                        <tbody id="liveLogsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-directory" class="section" style="display:none;">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0">Scout Directory</h5>
                    <div class="text-muted small">Total: <span id="dirCount">0</span></div>
                </div><input type="text" id="searchDir" class="form-control mb-3" placeholder="Search by Name or ID..."
                    onkeyup="filterDirectory()">
                <div class="table-responsive">
                    <table class="table align-middle table-hover custom-table">
                        <thead>
                            <tr>
                                <th>ID Number</th>
                                <th>Full Name</th>
                                <th>Troop</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dirTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-registration" class="section" style="display:none;">
            <div class="stat-card admin-only">
                <h4 class="fw-bold mb-4">Register New Scouts</h4>
                <div class="row">
                    <div class="col-md-6 border-end"><label class="form-label fw-bold text-secondary">Bulk Import
                            (CSV)</label><textarea id="bulkText" class="form-control mb-3" rows="8"
                            placeholder="Format:&#10;KG15/001, Kamal Perera"></textarea><button
                            class="btn btn-primary w-100 mb-3" onclick="processBulkSafely()">Process & Download
                            IDs</button>
                        <div class="d-flex gap-2"><button class="btn btn-outline-success btn-sm w-50"
                                onclick="exportData()">Backup DB</button><button
                                class="btn btn-outline-secondary btn-sm w-50"
                                onclick="document.getElementById('importFile').click()">Restore DB</button></div>
                    </div>
                    <div class="col-md-6 ps-md-4">
                        <h6 class="fw-bold mb-3">Recently Registered</h6>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm">
                                <tbody id="regTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-events" class="section" style="display:none;">
            <div class="row">
                <div class="col-md-4 admin-only">
                    <div class="stat-card">
                        <h5 class="fw-bold mb-3">Create Event</h5><select id="evtType" class="form-select mb-3">
                            <option value="ACCESS">Entrance (IN/OUT)</option>
                            <option value="ONETIME">Activity (One-Time)</option>
                            <option value="CUSTOM">Custom Buttons</option>
                        </select><input type="text" id="evtName" class="form-control mb-2"
                            placeholder="Event Name"><input type="text" id="evtButtons" class="form-control mb-2"
                            value="IN,OUT" placeholder="Buttons (comma separated)">
                        <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox"
                                id="evtOneTime"><label class="form-check-label small" for="evtOneTime">One-Time
                                Only</label></div><button onclick="addEvent()" class="btn btn-primary w-100">Add
                            Event</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="stat-card">
                        <h6 class="fw-bold mb-3">Active Events List</h6>
                        <div id="eventsList"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-staff" class="section" style="display:none;">
            <div class="stat-card">
                <h5 class="fw-bold mb-4">Manage Staff Access</h5>
                <div class="row g-2 mb-4 align-items-end">
                    <div class="col-md-4"><input type="email" id="stfEmail" class="form-control"
                            placeholder="New Staff Email"></div>
                    <div class="col-md-3"><input type="text" id="stfPass" class="form-control" placeholder="Password">
                    </div>
                    <div class="col-md-3"><select id="stfRole" class="form-select">
                            <option value="scanner">Scanner</option>
                            <option value="admin">Admin</option>
                        </select></div>
                    <div class="col-md-2"><button onclick="addStaff()" class="btn btn-dark w-100">Add User</button>
                    </div>
                </div>
                <table class="table align-middle custom-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="staffTable"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-settings" class="section" style="display:none;">
            <div class="stat-card border-danger border-start border-5">
                <h3 class="fw-bold text-danger mb-3">System Reset</h3>
                <p class="text-muted">This will wipe all Scouts, Logs, and Counters. This cannot be undone.</p><button
                    onclick="initiateSystemReset()" class="btn btn-danger fw-bold">WIPE ALL DATA</button>
            </div>
        </div>

        <div class="footer-credit">
            Designed & Developed by <strong>Madhawa Basnayake</strong>
        </div>

    </div>

    <div class="offcanvas offcanvas-end border-0 shadow-lg" tabindex="-1" id="scoutOffcanvas" style="width: 400px;">
        <div class="offcanvas-header bg-light">
            <h5 class="offcanvas-title fw-bold">Scout Details</h5><button type="button" class="btn-close"
                data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <div
                style="background: linear-gradient(135deg, #4F46E5, #818CF8); color: white; padding: 40px 20px; text-align: center;">
                <div
                    style="width: 90px; height: 90px; background: white; color: var(--primary); border-radius: 50%; font-size: 40px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <i class="bi bi-person-fill"></i>
                </div>
                <h4 class="fw-bold mb-1" id="panelName">...</h4>
                <div class="badge bg-white text-primary rounded-pill px-3 py-2 mt-2" id="panelID">ID: ...</div>
                <div class="mt-2 opacity-75 small" id="panelTroop">Troop: -</div>
            </div>
            <div class="p-4 d-grid gap-3">
                <button id="btnToggleMissing" class="btn btn-outline-danger py-3 fw-bold"
                    onclick="toggleMissingFromPanel()"><i class="bi bi-exclamation-triangle-fill me-2"></i> Report
                    Missing</button>
                <button onclick="downloadSingleID()" class="btn btn-primary py-3 fw-bold"><i
                        class="bi bi-qr-code me-2"></i> Download ID Card</button>
                <hr>
                <button onclick="deleteScoutFromPanel()"
                    class="btn btn-danger text-danger bg-light border-0 py-3 fw-bold admin-only"><i
                        class="bi bi-trash-fill me-2"></i> Delete Profile</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, serverTimestamp, get, remove, update, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyCIrXtwckl-4RPOXDn5IOMiHFh_uXdPiKQ", authDomain: "scoutpass-276cb.firebaseapp.com", projectId: "scoutpass-276cb", databaseURL: "https://scoutpass-276cb-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getDatabase(app); const secondaryApp = initializeApp(firebaseConfig, "Secondary"); const secondaryAuth = getAuth(secondaryApp);

        let allScouts = [], allEvents = [], globalStats = {}; let currentUserRole = 'admin'; let selectedScoutData = null;

        setInterval(() => { const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString(); document.getElementById('dateDisplay').innerText = now.toLocaleDateString(); }, 1000);

        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = "index.html";
            else {
                const snap = await get(ref(db, `users/${user.uid}`));
                if (snap.exists()) {
                    currentUserRole = snap.val().role || 'admin';
                    if (currentUserRole === 'scanner') { document.body.innerHTML = "<div style='display:flex;height:100vh;align-items:center;justify-content:center;flex-direction:column'><h1>Access Denied</h1><p>Please use the Mobile Scanner App</p></div>"; return; }
                    if (currentUserRole === 'admin') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                    document.getElementById('loading-screen').style.display = 'none';
                }
                set(ref(db, `presence/${user.uid}`), { email: user.email, online: true });
            }
        });

        onValue(ref(db, 'scouts'), (s) => { allScouts = s.exists() ? Object.values(s.val()) : []; document.getElementById('statTotalScouts').innerText = allScouts.length; document.getElementById('dirCount').innerText = allScouts.length; updateDirectory(); });
        onValue(ref(db, 'stats'), (s) => { globalStats = s.val() || {}; document.getElementById('statTotalScans').innerText = globalStats.total_scans || 0; document.getElementById('statInside').innerText = Math.max(0, globalStats.inside_count || 0); const todayStr = new Date().toISOString().split('T')[0]; document.getElementById('statTodayScans').innerText = (globalStats.daily && globalStats.daily[todayStr]) ? globalStats.daily[todayStr] : 0; renderEventCards(); });
        onValue(ref(db, 'events'), (s) => { const data = s.val(); allEvents = data ? Object.entries(data).map(([key, val]) => ({ key, ...val })) : []; renderEventsList(); renderEventCards(); });
        onValue(query(ref(db, 'logs'), limitToLast(50)), (s) => { const list = document.getElementById('liveLogsBody'); list.innerHTML = ""; if (s.exists()) { Object.values(s.val()).reverse().forEach(l => { let badge = `<span class="badge bg-light text-dark border">SCAN</span>`; if (l.action === 'IN') badge = `<span class="badge bg-success bg-opacity-10 text-success border border-success">IN</span>`; if (l.action === 'OUT') badge = `<span class="badge bg-danger bg-opacity-10 text-danger border border-danger">OUT</span>`; list.innerHTML += `<tr><td>${new Date(l.timestamp).toLocaleTimeString()}</td><td class="fw-bold text-primary">${l.scoutName}</td><td>${l.eventName}</td><td>${badge}</td><td class="text-muted small">${l.scannedBy ? l.scannedBy.split('@')[0] : 'System'}</td></tr>`; }); } else { list.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">No recent activity</td></tr>`; } });

        function renderEventCards() {
            const container = document.getElementById('liveEventCards'); container.innerHTML = ""; if (allEvents.length === 0) { container.innerHTML = `<div class="col-12 text-center text-muted">No events active.</div>`; return; }
            allEvents.forEach(evt => {
                if (evt.isDeleted) return; const evtStats = (globalStats.events && globalStats.events[evt.name]) || { in: 0, out: 0, total: 0 }; let body = '';
                if (evt.type === 'ACCESS') { const inside = Math.max(0, (evtStats.in || 0) - (evtStats.out || 0)); body = `<div class="d-flex justify-content-between text-center mt-3"><div><div class="h4 fw-bold mb-0">${evtStats.in || 0}</div><small class="text-muted">In</small></div><div><div class="h4 fw-bold mb-0">${evtStats.out || 0}</div><small class="text-muted">Out</small></div><div><div class="h4 fw-bold text-primary mb-0">${inside}</div><small class="text-primary fw-bold">Active</small></div></div>`; }
                else { body = `<div class="text-center mt-3"><h2 class="text-success fw-bold mb-0">${evtStats.total || 0}</h2><small class="text-muted">Total Completed</small></div>`; }
                container.innerHTML += `<div class="col-md-4"><div class="stat-card"><div class="d-flex justify-content-between align-items-center mb-2"><h6 class="fw-bold mb-0 text-truncate">${evt.name}</h6><span class="badge bg-light text-dark border">${evt.type}</span></div>${body}</div></div>`;
            });
        }

        function updateDirectory() { const tbody = document.getElementById('dirTable'); let h = ''; allScouts.slice().reverse().slice(0, 100).forEach(sc => { const safeKey = sc.id.replace(/[.#$/[\]]/g, '_'); const status = sc.isMissing ? '<span class="badge bg-danger rounded-pill">MISSING</span>' : '<span class="badge bg-success rounded-pill">Active</span>'; h += `<tr onclick="viewScout('${safeKey}')"><td class="fw-bold font-monospace">${sc.id}</td><td class="fw-bold text-primary">${sc.name}</td><td>${sc.troop || '-'}</td><td>${status}</td></tr>`; }); tbody.innerHTML = h; }
        window.filterDirectory = () => { const term = document.getElementById('searchDir').value.toLowerCase(); const tbody = document.getElementById('dirTable'); tbody.innerHTML = ''; const filtered = allScouts.filter(s => s.name.toLowerCase().includes(term) || s.id.toLowerCase().includes(term)).slice(0, 50); filtered.forEach(sc => { const safeKey = sc.id.replace(/[.#$/[\]]/g, '_'); const status = sc.isMissing ? '<span class="badge bg-danger">MISSING</span>' : '<span class="badge bg-success">Active</span>'; tbody.innerHTML += `<tr onclick="viewScout('${safeKey}')"><td>${sc.id}</td><td class="fw-bold text-primary">${sc.name}</td><td>${sc.troop || '-'}</td><td>${status}</td></tr>`; }); };

        window.viewScout = (safeKey) => { const sc = allScouts.find(s => s.id.replace(/[.#$/[\]]/g, '_') === safeKey); if (sc) { selectedScoutData = sc; document.getElementById('panelName').innerText = sc.name; document.getElementById('panelID').innerText = `ID: ${sc.id}`; document.getElementById('panelTroop').innerText = `Troop: ${sc.troop || '-'}`; const btn = document.getElementById('btnToggleMissing'); if (sc.isMissing) { btn.className = "btn btn-success py-3 fw-bold"; btn.innerHTML = '<i class="bi bi-shield-check-fill me-2"></i> Mark Found (Safe)'; } else { btn.className = "btn btn-outline-danger py-3 fw-bold"; btn.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i> Report Missing'; } new bootstrap.Offcanvas(document.getElementById('scoutOffcanvas')).show(); } };
        window.toggleMissingFromPanel = async () => { if (!selectedScoutData) return; const safeKey = selectedScoutData.id.replace(/[.#$/[\]]/g, '_'); const newState = !selectedScoutData.isMissing; await update(ref(db, `scouts/${safeKey}`), { isMissing: newState }); if (newState) push(ref(db, 'alerts'), { scoutName: selectedScoutData.name, timestamp: serverTimestamp() }); viewScout(safeKey); };
        window.deleteScoutFromPanel = async () => { if (!selectedScoutData) return; const result = await Swal.fire({ title: 'Delete Profile?', text: "This cannot be undone!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, Delete' }); if (result.isConfirmed) { const safeKey = selectedScoutData.id.replace(/[.#$/[\]]/g, '_'); await remove(ref(db, `scouts/${safeKey}`)); bootstrap.Offcanvas.getInstance(document.getElementById('scoutOffcanvas')).hide(); Swal.fire('Deleted', 'Scout removed.', 'success'); } };

        window.addStaff = async () => { try { const c = await createUserWithEmailAndPassword(secondaryAuth, document.getElementById('stfEmail').value, document.getElementById('stfPass').value); await set(ref(db, `users/${c.user.uid}`), { email: c.user.email, role: document.getElementById('stfRole').value }); Swal.fire('Success', 'User Created', 'success'); } catch (e) { Swal.fire('Error', e.message, 'error'); } };
        onValue(ref(db, 'users'), s => { const t = document.getElementById('staffTable'); t.innerHTML = ""; if (s.exists()) Object.entries(s.val()).forEach(([k, v]) => { const delBtn = currentUserRole === 'admin' ? `<button onclick="removeUser('${k}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash-fill"></i></button>` : ''; t.innerHTML += `<tr><td>${v.email}</td><td><span class="badge bg-light text-dark border">${v.role}</span></td><td>${delBtn}</td></tr>`; }); });
        window.removeUser = (k) => remove(ref(db, `users/${k}`));

        onValue(ref(db, 'alerts'), (snap) => { const tbody = document.getElementById('alertsTableBody'); if (snap.exists()) { const alerts = Object.entries(snap.val()); document.getElementById('alertBadge').innerText = alerts.length; document.getElementById('alertBadge').style.display = 'inline-block'; tbody.innerHTML = ""; alerts.forEach(([k, v]) => tbody.innerHTML += `<tr><td class="text-danger fw-bold"><i class="bi bi-exclamation-circle-fill me-2"></i>MISSING: ${v.scoutName}</td><td class="text-end"><button class="btn btn-sm btn-dark" onclick="removeAlert('${k}')">Found</button></td></tr>`); } else { document.getElementById('alertBadge').style.display = 'none'; tbody.innerHTML = "<tr><td colspan='2' class='text-center text-muted'>All scouts are safe.</td></tr>"; } });
        window.removeAlert = (k) => remove(ref(db, `alerts/${k}`));

        const systemRef = ref(db, 'system_settings/scanning_active'); let isScannerLocked = false;
        onValue(systemRef, (s) => { isScannerLocked = !s.val(); const btn = document.getElementById("globalLockBtn"); if (isScannerLocked) { btn.className = "lock-btn locked admin-only"; btn.innerHTML = '<i class="bi bi-lock-fill"></i> Scanners Locked'; } else { btn.className = "lock-btn unlocked admin-only"; btn.innerHTML = '<i class="bi bi-unlock-fill"></i> Scanners Active'; } });
        window.toggleScannerLock = () => set(systemRef, isScannerLocked);
        window.addEvent = async () => { const n = document.getElementById('evtName').value, t = document.getElementById('evtType').value, b = document.getElementById('evtButtons').value; if (n) { await push(ref(db, 'events'), { name: n, type: t, buttons: b.split(','), active: true, isOneTime: document.getElementById('evtOneTime').checked, isDeleted: false }); document.getElementById('evtName').value = ''; } };
        function renderEventsList() { let h = ''; allEvents.forEach(e => { if (e.isDeleted) return; h += `<div class="event-item"><div><strong>${e.name}</strong><br><small class="text-muted">${e.type}</small></div><button onclick="removeEvent('${e.key}')" class="btn btn-sm text-danger admin-only"><i class="bi bi-trash"></i></button></div>`; }); document.getElementById('eventsList').innerHTML = h; }
        window.removeEvent = async (k) => { if (confirm('Delete Event?')) update(ref(db, `events/${k}`), { isDeleted: true }); };
        window.initiateSystemReset = async () => { const p = prompt("Type password:"); if (p === "MadhawaBasnayake@20041110") { await remove(ref(db, 'scouts')); await remove(ref(db, 'logs')); await remove(ref(db, 'events')); await remove(ref(db, 'alerts')); await set(ref(db, 'stats'), { total_scans: 0, inside_count: 0, daily: {} }); alert('System Wiped'); } };

        window.showSection = (id, el) => { document.querySelectorAll('.section').forEach(d => d.style.display = 'none'); document.getElementById('sec-' + id).style.display = 'block'; document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if (el) el.classList.add('active'); document.getElementById('pageTitle').innerText = id === 'overview' ? 'Dashboard' : id.charAt(0).toUpperCase() + id.slice(1); };
        window.processBulkSafely = async function () { const text = document.getElementById('bulkText').value; const lines = text.trim().split('\n'); const updates = {}; const list = []; lines.forEach(l => { const p = l.split(','); if (p.length >= 2) { const id = p[0].trim(); const name = p.slice(1).join(',').trim(); if (id && name) { const k = id.replace(/[.#$/[\]]/g, '_'); const obj = { id: id, name: name, troop: "-", isMissing: false }; updates[`scouts/${k}`] = obj; list.push(obj); } } }); await update(ref(db), updates); Swal.fire('Success', `Registered ${list.length} scouts`, 'success'); downloadBatchPDF(list, 'New_IDs'); };
        window.downloadBatchPDF = function (scoutList, filename) { if (!scoutList || scoutList.length === 0) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const qrDiv = document.getElementById('qr-hidden'); let col = 0, row = 0; const cardW = 45, cardH = 65, marginX = 15, marginY = 15; scoutList.forEach((s, i) => { if (i > 0 && i % 16 === 0) { doc.addPage(); col = 0; row = 0; } qrDiv.innerHTML = ""; new QRCode(qrDiv, { text: s.id, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.M }); const img = qrDiv.querySelector('canvas').toDataURL("image/png"); const x = marginX + (col * (cardW + 2)); const y = marginY + (row * (cardH + 2)); const centerX = x + (cardW / 2); doc.setLineWidth(0.1); doc.rect(x, y, cardW, cardH); doc.setFontSize(8); doc.setFont("helvetica", "bold"); doc.text("SCOUT PASS", centerX, y + 6, { align: "center" }); doc.addImage(img, 'PNG', x + 5, y + 8, 35, 35); doc.setFontSize(10); doc.text(s.id, centerX, y + 49, { align: "center" }); doc.setFontSize(8); doc.setFont("helvetica", "normal"); let printName = s.name.length > 18 ? s.name.substring(0, 16) + '..' : s.name; doc.text(printName, centerX, y + 54, { align: "center" }); doc.setFontSize(6); doc.setTextColor(150); doc.text("SCAN TO VERIFY", centerX, y + 60, { align: "center" }); doc.setTextColor(0); col++; if (col >= 4) { col = 0; row++; } }); doc.save(`${filename}.pdf`); }
        window.downloadSingleID = () => selectedScoutData && downloadBatchPDF([selectedScoutData], selectedScoutData.id.replace(/[.#$/[\]]/g, '_'));
        window.exportData = function () { if (allScouts.length === 0) return Swal.fire('Empty', 'No data', 'info'); const dataStr = JSON.stringify(allScouts, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ScoutDB_Backup.json`; a.click(); }
        window.importData = function (input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async function (e) { try { const data = JSON.parse(e.target.result); const updates = {}; data.forEach(s => { const k = s.id.replace(/[.#$/[\]]/g, '_'); updates[`scouts/${k}`] = s; }); await update(ref(db), updates); Swal.fire('Success', `Restored ${data.length} records.`, 'success'); } catch (err) { Swal.fire('Error', 'Invalid File', 'error'); } input.value = ''; }; reader.readAsText(file); }
        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
    </script>
</body>

</html>